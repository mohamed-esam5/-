<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“‚ Ù…Ø£Ù…ÙˆØ±ÙŠØ§ØªÙƒ</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      background: #f0f4f8;
      padding: 20px;
    }
    .page-container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2575fc;
    }
    select, input, button, textarea {
      margin: 5px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    button {
      background: linear-gradient(135deg, #2575fc, #6a11cb);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .mission-item {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 10px 0;
      padding: 15px;
      background: #fafafa;
      position: relative;
    }
    .mission-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .edit-form {
      margin-top: 10px;
      background: #eef2ff;
      padding: 10px;
      border-radius: 8px;
    }
    .navigation {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="page-container" id="missionsPage" style="display:none;">
    <h1>ğŸ“‚ Ù…Ø£Ù…ÙˆØ±ÙŠØ§ØªÙƒ</h1>

    <!-- ÙÙ„ØªØ±Ø© -->
    <div class="filters">
      <select id="filter-type">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
        <option value="external">Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬</option>
        <option value="open">Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù…ÙØªÙˆØ­Ø©</option>
        <option value="return">Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ø¹ÙˆØ¯Ø©</option>
      </select>
      <input type="date" id="filter-date">

      <!-- âœ… ÙÙ„ØªØ± Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· -->
      <select id="filter-name" style="display:none;">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
      </select>

      <button onclick="loadMissions()">ğŸ” Ø¨Ø­Ø«</button>
      <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div id="missions-list">
      <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <div class="navigation">
      <button onclick="window.location.href='employee.html'">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
    import { db, collection, getDocs, doc, getDoc, deleteDoc, setDoc, query, where } from "./firebase.js";

    const auth = getAuth();
    let currentUser = null;
    let isManager = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        window.location.href = "index.html";
        return;
      }

      currentUser = user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      const roles = userDoc.data()?.roles || [];

      isManager = roles.includes("manager");

      // âœ… Ù„Ùˆ Ù…Ø¯ÙŠØ± Ø£Ø¸Ù‡Ø± ÙÙ„ØªØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ­Ù…Ù‘Ù„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      if (isManager) {
        document.getElementById("filter-name").style.display = "inline-block";
        await loadEmployeeNames();
      }

      document.getElementById("missionsPage").style.display = "block";
      loadMissions();
    });

    async function loadEmployeeNames() {
      const select = document.getElementById("filter-name");
      select.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';

      const usersSnap = await getDocs(collection(db, "users"));
      usersSnap.forEach(docSnap => {
        const data = docSnap.data();
        const roles = data.roles || [data.role];
        if (roles.includes("employee")) {
          const option = document.createElement("option");
          option.value = docSnap.id; // uid
          option.textContent = data.username;
          select.appendChild(option);
        }
      });
    }

    async function loadMissions() {
      const container = document.getElementById("missions-list");
      container.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>";

      const typeFilter = document.getElementById("filter-type").value;
      const dateFilter = document.getElementById("filter-date").value;
      const nameFilter = isManager ? document.getElementById("filter-name").value : "";

      const missionsRef = collection(db, "missions");
      const q = isManager ? missionsRef : query(missionsRef, where("uid", "==", currentUser.uid));
      const snapshot = await getDocs(q);

      container.innerHTML = "";
      let found = false;

      for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        const id = docSnap.id;

        if (!isManager && data.uid !== currentUser.uid) continue;
        if (typeFilter && data.type !== typeFilter) continue;
        if (dateFilter && data.date !== dateFilter) continue;
        if (isManager && nameFilter && data.uid !== nameFilter) continue; // âœ… ÙÙ„ØªØ± Ø¨Ø§Ù„Ø§Ø³Ù…

        found = true;

        const item = document.createElement("div");
        item.classList.add("mission-item");

        let employeeName = isManager ? await getEmployeeName(data.uid) : "";

        item.innerHTML = `
          ${isManager ? `<p><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${employeeName}</p>` : ""}
          <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${translateType(data.type)}</p>
          <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${data.date}</p>
          <p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${data.details}</p>
          <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> ${new Date(data.createdDate).toLocaleString("ar-EG")}</p>
        `;

        if (isManager) {
          const actions = document.createElement("div");
          actions.classList.add("mission-actions");
          actions.innerHTML = `
            <button onclick="showEditForm('${id}', '${data.type}', '${data.date}', \`${data.details}\`)">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="deleteMission('${id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          `;
          item.appendChild(actions);
        }

        container.appendChild(item);
      }

      if (!found) {
        container.innerHTML = "<p>ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø£Ù…ÙˆØ±ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</p>";
      }
    }
    window.loadMissions = loadMissions;

    async function getEmployeeName(uid) {
      if (!isManager) return "";
      try {
        const userDoc = await getDoc(doc(db, "users", uid));
        return userDoc.exists() ? userDoc.data().username || uid : uid;
      } catch {
        return uid;
      }
    }

    function translateType(type) {
      switch(type) {
        case "external": return "Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬";
        case "open": return "Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù…ÙØªÙˆØ­Ø©";
        case "return": return "Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ø¹ÙˆØ¯Ø©";
        default: return type;
      }
    }

    window.deleteMission = async function(id) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ©ØŸ")) return;
      await deleteDoc(doc(db, "missions", id));
      alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù");
      loadMissions();
    }

    window.showEditForm = function(id, type, date, details) {
      const container = document.getElementById("missions-list");
      const form = document.createElement("div");
      form.classList.add("edit-form");
      form.innerHTML = `
        <h4>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ©</h4>
        <select id="edit-type">
                    <option value="external" ${type === "external" ? "selected" : ""}>Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬</option>
          <option value="open" ${type === "open" ? "selected" : ""}>Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ù…ÙØªÙˆØ­Ø©</option>
          <option value="return" ${type === "return" ? "selected" : ""}>Ù…Ø£Ù…ÙˆØ±ÙŠØ© Ø¹ÙˆØ¯Ø©</option>
        </select>
        <input type="date" id="edit-date" value="${date}">
        <textarea id="edit-details">${details}</textarea>
        <div style="margin-top:10px;">
          <button onclick="submitEdit('${id}')">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="loadMissions()">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>
      `;
      container.innerHTML = "";
      container.appendChild(form);
    }

    window.submitEdit = async function(id) {
      const type = document.getElementById("edit-type").value;
      const date = document.getElementById("edit-date").value;
      const details = document.getElementById("edit-details").value.trim();

      if (!type || !date || !details) {
        alert("âš ï¸ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
      }

      const ref = doc(db, "missions", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø£Ù…ÙˆØ±ÙŠØ©");
        return;
      }

      const oldData = snap.data();

      await setDoc(ref, {
        ...oldData,
        type,
        date,
        details
      });

      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
      loadMissions();
    }
  </script>
</body>
</html>