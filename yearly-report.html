<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📆 التقارير السنوية</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: 'Cairo', sans-serif; direction: rtl; background: #d2e2eb; margin: 0; padding: 20px; color: #000000; }
    .page-container { max-width: 1100px; margin: auto; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    h1 { text-align: center; color: #0072ff; }
    h3 { margin-top: 20px; color: #0072ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #000000; padding: 8px; text-align: center; }
    th { background: #0072ff; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    .stats { display: flex; justify-content: space-around; margin: 20px 0; flex-wrap: wrap; gap: 15px; }
    .stat-box { background: #eef6ff; border: 2px solid #007bff; border-radius: 10px; padding: 15px; width: 30%; text-align: center; }
    .filters { display: flex; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    .filters select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; min-width: 180px; }
    .buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <div class="page-container">
    <h1>📆 تقرير سنوي</h1>

    <!-- ✅ الفلاتر -->
    <div class="filters">
      <select id="yearFilter"></select>
      <select id="monthFilter">
        <option value="">كل الشهور</option>
        <option value="0">يناير</option>
        <option value="1">فبراير</option>
        <option value="2">مارس</option>
        <option value="3">أبريل</option>
        <option value="4">مايو</option>
        <option value="5">يونيو</option>
        <option value="6">يوليو</option>
        <option value="7">أغسطس</option>
        <option value="8">سبتمبر</option>
        <option value="9">أكتوبر</option>
        <option value="10">نوفمبر</option>
        <option value="11">ديسمبر</option>
      </select>
      <select id="employeeFilter"><option value="">كل الموظفين</option></select>
      <select id="typeFilter">
        <option value="">كل الأنواع</option>
        <option value="casual">إجازة عارضة</option>
        <option value="annual">إجازة اعتيادية</option>
        <option value="half-hour">نصف ساعة</option>
        <option value="hour">ساعة</option>
        <option value="quarter-morning">ربع يوم صباحًا</option>
        <option value="half-day">نصف يوم</option>
        <option value="quarter-evening">ربع يوم مساءً</option>
      </select>
    </div>

    <!-- ✅ الإحصائيات -->
    <div class="stats">
      <div class="stat-box"><h3>إجمالي الطلبات</h3><p id="totalRequests">0</p></div>
      <div class="stat-box"><h3>أكثر نوع إذن</h3><p id="topType">-</p></div>
      <div class="stat-box"><h3>أكثر موظف طلب</h3><p id="topEmployee">-</p></div>
    </div>

    <!-- ✅ مكان الجداول -->
    <div id="yearly-report-container"></div>

    <!-- ✅ أزرار التصدير -->
    <div class="buttons">
      <button onclick="exportPDF()">📄 تصدير السنة PDF</button>
      <button onclick="exportCSV()">📊 تصدير السنة Excel</button>
      <button onclick="exportMonthPDF()">📄 تصدير الشهر المحدد PDF</button>
      <button onclick="exportMonthCSV()">📊 تصدير الشهر المحدد Excel</button>
      <button onclick="goBack()">🔙 رجوع</button>
    </div>
  </div>

  <script type="module">
    import { db, getDocs, collection } from './firebase.js';

    let allRequests = [];

    async function loadYearlyReport() {
      const container = document.getElementById("yearly-report-container");
      container.innerHTML = "";

      const role = localStorage.getItem("role");
      const currentUser = localStorage.getItem("name");
      const selectedYear = parseInt(document.getElementById("yearFilter").value);

      const snapshot = await getDocs(collection(db, "dailyRequests"));
      allRequests = [];
      let employeesSet = new Set();

      snapshot.forEach(doc => {
        const data = doc.data();
        const leaveDate = new Date(data.leaveDate);
        const sameYear = leaveDate.getFullYear() === selectedYear;
        const allowed = role === "manager" || data.name === currentUser;

        if (sameYear && allowed) {
          allRequests.push(data);
          employeesSet.add(data.name);
        }
      });

      // تعبئة قائمة الموظفين
      const employeeFilter = document.getElementById("employeeFilter");
      employeeFilter.innerHTML = '<option value="">كل الموظفين</option>';
      employeesSet.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        employeeFilter.appendChild(option);
      });

      renderTables();
    }

    function updateStats(filtered) {
      document.getElementById("totalRequests").textContent = filtered.length;

      let typeCount = {}, employeeCount = {};
      filtered.forEach(req => {
        typeCount[req.type] = (typeCount[req.type] || 0) + 1;
        employeeCount[req.name] = (employeeCount[req.name] || 0) + 1;
      });

      let topType = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0];
      let topEmployee = Object.entries(employeeCount).sort((a,b)=>b[1]-a[1])[0];

      document.getElementById("topType").textContent = topType ? `${topType[0]} (${topType[1]})` : "-";
      document.getElementById("topEmployee").textContent = topEmployee ? `${topEmployee[0]} (${topEmployee[1]})` : "-";
    }

    function renderTables() {
      const container = document.getElementById("yearly-report-container");
      container.innerHTML = "";

      const employeeFilter = document.getElementById("employeeFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const monthFilter = document.getElementById("monthFilter").value;

      const filtered = allRequests.filter(req => {
        const d = new Date(req.leaveDate);
        return (
          (employeeFilter === "" || req.name === employeeFilter) &&
          (typeFilter === "" || req.type === typeFilter) &&
          (monthFilter === "" || d.getMonth() == monthFilter)
        );
      });

      updateStats(filtered);

      if (filtered.length === 0) {
        container.innerHTML = "<p>لا توجد طلبات مطابقة</p>";
        return;
      }

      // تجميع حسب الشهر
      const grouped = {};
      filtered.forEach(req => {
        const d = new Date(req.leaveDate);
        const month = d.getMonth();
        if (!grouped[month]) grouped[month] = [];
        grouped[month].push(req);
      });

            const months = [
        "يناير","فبراير","مارس","أبريل","مايو","يونيو",
        "يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"
      ];

      Object.keys(grouped).sort((a,b)=>a-b).forEach(m => {
        const section = document.createElement("div");
        section.innerHTML = `
          <h3>${months[m]}</h3>
          <table>
            <thead>
              <tr>
                <th>الموظف</th>
                <th>نوع الإذن</th>
                <th>السبب</th>
                <th>تاريخ الإذن</th>
                <th>تاريخ التسجيل</th>
              </tr>
            </thead>
            <tbody>
              ${grouped[m].map(data => `
                <tr>
                  <td>${data.name}</td>
                  <td>${data.type}</td>
                  <td>${data.reason}</td>
                  <td>${data.leaveDate}</td>
                  <td>${new Date(data.createdDate).toLocaleString("ar-EG")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
        container.appendChild(section);
      });
    }

    // ✅ تصدير PDF للسنة كلها
    window.exportPDF = function() {
      window.print();
    };

    // ✅ تصدير CSV للسنة كلها
    window.exportCSV = function() {
      let csv = "اسم الموظف,نوع الإذن,السبب,تاريخ القيام,تاريخ التسجيل\n";
      const rows = document.querySelectorAll("#yearly-report-container table tbody tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        let rowData = [];
        cols.forEach(col => rowData.push(col.innerText));
        csv += rowData.join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "yearly_requests.csv";
      link.click();
    };

    // ✅ تصدير شهر محدد PDF
    window.exportMonthPDF = function() {
      const month = document.getElementById("monthFilter").value;
      if (month === "") {
        alert("من فضلك اختر شهر أولاً");
        return;
      }
      const allSections = document.querySelectorAll("#yearly-report-container > div");
      allSections.forEach((sec, idx) => {
        sec.style.display = (parseInt(Object.keys(allRequests.map(r=>new Date(r.leaveDate).getMonth())).indexOf(month)) === idx) ? "block" : "none";
      });
      window.print();
      allSections.forEach(sec => sec.style.display = "block");
    };

    // ✅ تصدير شهر محدد CSV
    window.exportMonthCSV = function() {
      const month = document.getElementById("monthFilter").value;
      if (month === "") {
        alert("من فضلك اختر شهر أولاً");
        return;
      }
      let csv = "اسم الموظف,نوع الإذن,السبب,تاريخ القيام,تاريخ التسجيل\n";
      const rows = document.querySelectorAll("#yearly-report-container > div")[month]?.querySelectorAll("tbody tr") || [];
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        let rowData = [];
        cols.forEach(col => rowData.push(col.innerText));
        csv += rowData.join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `requests_month_${parseInt(month)+1}.csv`;
      link.click();
    };

    // ✅ تحديث الجدول والإحصائيات عند تغيير الفلاتر
    document.getElementById("employeeFilter").addEventListener("change", renderTables);
    document.getElementById("typeFilter").addEventListener("change", renderTables);
    document.getElementById("monthFilter").addEventListener("change", renderTables);
    document.getElementById("yearFilter").addEventListener("change", loadYearlyReport);

    // ✅ زر الرجوع
    window.goBack = function() {
      window.location.href = "manager.html";
    };

    // ✅ تعبئة قائمة السنوات (آخر 5 سنوات + السنة الحالية)
    function populateYears() {
      const yearSelect = document.getElementById("yearFilter");
      const currentYear = new Date().getFullYear();
      for (let y = currentYear; y >= currentYear - 5; y--) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }

    // تحميل البيانات عند فتح الصفحة
    populateYears();
    loadYearlyReport();
  </script>
</body>
</html>
